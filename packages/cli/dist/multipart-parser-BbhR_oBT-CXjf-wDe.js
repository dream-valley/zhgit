import{f as e,a as t}from"./index.js";import"os";import"tty";import"path";import"fs";import"child_process";import"node:http";import"node:https";import"node:zlib";import"node:stream";import"node:buffer";import"node:util";import"node:url";import"node:net";import"node:fs";import"node:path";import"keytar";import"node:process";import"constants";import"stream";import"util";import"assert";import"url";import"node:events";import"node:child_process";let n=0;const r={START_BOUNDARY:n++,HEADER_FIELD_START:n++,HEADER_FIELD:n++,HEADER_VALUE_START:n++,HEADER_VALUE:n++,HEADER_VALUE_ALMOST_DONE:n++,HEADERS_ALMOST_DONE:n++,PART_DATA_START:n++,PART_DATA:n++,END:n++};let o=1;const a=o,i=o*=2,s=e=>32|e,d=()=>{};class E{constructor(e){this.index=0,this.flags=0,this.onHeaderEnd=d,this.onHeaderField=d,this.onHeadersEnd=d,this.onHeaderValue=d,this.onPartBegin=d,this.onPartData=d,this.onPartEnd=d,this.boundaryChars={},e="\r\n--"+e;const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n),this.boundaryChars[t[n]]=!0;this.boundary=t,this.lookbehind=new Uint8Array(this.boundary.length+8),this.state=r.START_BOUNDARY}write(e){let t=0;const n=e.length;let o=this.index,{lookbehind:d,boundary:E,boundaryChars:A,index:h,state:l,flags:c}=this;const D=this.boundary.length,f=D-1,_=e.length;let T,p;const u=e=>{this[e+"Mark"]=t},R=e=>{delete this[e+"Mark"]},m=(e,t,n,r)=>{void 0!==t&&t===n||this[e](r&&r.subarray(t,n))},H=(n,r)=>{const o=n+"Mark";o in this&&(r?(m(n,this[o],t,e),delete this[o]):(m(n,this[o],e.length,e),this[o]=0))};for(t=0;t<n;t++)switch(T=e[t],l){case r.START_BOUNDARY:if(h===E.length-2){if(45===T)c|=i;else if(13!==T)return;h++;break}if(h-1==E.length-2){if(c&i&&45===T)l=r.END,c=0;else{if(c&i||10!==T)return;h=0,m("onPartBegin"),l=r.HEADER_FIELD_START}break}T!==E[h+2]&&(h=-2),T===E[h+2]&&h++;break;case r.HEADER_FIELD_START:l=r.HEADER_FIELD,u("onHeaderField"),h=0;case r.HEADER_FIELD:if(13===T){R("onHeaderField"),l=r.HEADERS_ALMOST_DONE;break}if(h++,45===T)break;if(58===T){if(1===h)return;H("onHeaderField",!0),l=r.HEADER_VALUE_START;break}if(p=s(T),p<97||p>122)return;break;case r.HEADER_VALUE_START:if(32===T)break;u("onHeaderValue"),l=r.HEADER_VALUE;case r.HEADER_VALUE:13===T&&(H("onHeaderValue",!0),m("onHeaderEnd"),l=r.HEADER_VALUE_ALMOST_DONE);break;case r.HEADER_VALUE_ALMOST_DONE:if(10!==T)return;l=r.HEADER_FIELD_START;break;case r.HEADERS_ALMOST_DONE:if(10!==T)return;m("onHeadersEnd"),l=r.PART_DATA_START;break;case r.PART_DATA_START:l=r.PART_DATA,u("onPartData");case r.PART_DATA:if(o=h,0===h){for(t+=f;t<_&&!(e[t]in A);)t+=D;t-=f,T=e[t]}if(h<E.length)E[h]===T?(0===h&&H("onPartData",!0),h++):h=0;else if(h===E.length)h++,13===T?c|=a:45===T?c|=i:h=0;else if(h-1===E.length)if(c&a){if(h=0,10===T){c&=~a,m("onPartEnd"),m("onPartBegin"),l=r.HEADER_FIELD_START;break}}else c&i&&45===T?(m("onPartEnd"),l=r.END,c=0):h=0;if(h>0)d[h-1]=T;else if(o>0){const e=new Uint8Array(d.buffer,d.byteOffset,d.byteLength);m("onPartData",0,o,e),o=0,u("onPartData"),t--}break;case r.END:break;default:throw new Error(`Unexpected state entered: ${l}`)}H("onHeaderField"),H("onHeaderValue"),H("onPartData"),this.index=h,this.state=l,this.flags=c}end(){if(this.state===r.HEADER_FIELD_START&&0===this.index||this.state===r.PART_DATA&&this.index===this.boundary.length)this.onPartEnd();else if(this.state!==r.END)throw new Error("MultipartParser.end(): stream ended unexpectedly")}}async function A(n,r){if(!/multipart/i.test(r))throw new TypeError("Failed to fetch");const o=r.match(/boundary=(?:"([^"]+)"|([^;]+))/i);if(!o)throw new TypeError("no or bad content-type header, no multipart boundary");const a=new E(o[1]||o[2]);let i,s,d,A,h,l;const c=[],D=new e,f=e=>{d+=u.decode(e,{stream:!0})},_=e=>{c.push(e)},T=()=>{const e=new t(c,l,{type:h});D.append(A,e)},p=()=>{D.append(A,d)},u=new TextDecoder("utf-8");u.decode(),a.onPartBegin=function(){a.onPartData=f,a.onPartEnd=p,i="",s="",d="",A="",h="",l=null,c.length=0},a.onHeaderField=function(e){i+=u.decode(e,{stream:!0})},a.onHeaderValue=function(e){s+=u.decode(e,{stream:!0})},a.onHeaderEnd=function(){if(s+=u.decode(),i=i.toLowerCase(),"content-disposition"===i){const e=s.match(/\bname=("([^"]*)"|([^()<>@,;:\\"/[\]?={}\s\t]+))/i);e&&(A=e[2]||e[3]||""),l=function(e){const t=e.match(/\bfilename=("(.*?)"|([^()<>@,;:\\"/[\]?={}\s\t]+))($|;\s)/i);if(!t)return;const n=t[2]||t[3]||"";let r=n.slice(n.lastIndexOf("\\")+1);return r=r.replace(/%22/g,'"'),r=r.replace(/&#(\d{4});/g,((e,t)=>String.fromCharCode(t))),r}(s),l&&(a.onPartData=_,a.onPartEnd=T)}else"content-type"===i&&(h=s);s="",i=""};for await(const e of n)a.write(e);return a.end(),D}export{A as toFormData};
